<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Desktop Pet Settings</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Microsoft YaHei', 'Segoe UI', sans-serif;
            background: #f5f5f5; color: #333;
            padding: 20px;
        }
        h1 { font-size: 18px; margin-bottom: 16px; }
        h2 { font-size: 14px; margin: 16px 0 8px; color: #666; }
        .card {
            background: white; border-radius: 12px;
            padding: 16px; margin-bottom: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        label { display: block; font-size: 13px; margin-bottom: 4px; color: #555; }
        input[type="text"], input[type="password"], input[type="number"], select {
            width: 100%; padding: 8px 12px;
            border: 1px solid #ddd; border-radius: 8px;
            font-size: 13px; margin-bottom: 8px;
            outline: none; transition: border-color 0.2s;
        }
        input:focus, select:focus { border-color: #7c4dff; }
        .btn {
            padding: 8px 20px; border: none; border-radius: 8px;
            font-size: 13px; cursor: pointer; transition: all 0.2s;
        }
        .btn-primary { background: #7c4dff; color: white; }
        .btn-primary:hover { background: #651fff; }
        .btn-secondary { background: #e0e0e0; color: #333; }
        .btn-secondary:hover { background: #d0d0d0; }
        .btn-danger { background: #ff5252; color: white; }
        .btn-danger:hover { background: #ff1744; }
        .btn-sm { padding: 4px 12px; font-size: 12px; }
        .btn-row { display: flex; gap: 8px; margin-top: 12px; }
        textarea {
            width: 100%; padding: 8px 12px;
            border: 1px solid #ddd; border-radius: 8px;
            font-size: 13px; margin-bottom: 8px;
            outline: none; transition: border-color 0.2s;
            font-family: inherit; resize: vertical; min-height: 60px;
        }
        textarea:focus { border-color: #7c4dff; }
        .tabs { display: flex; gap: 0; margin-bottom: 16px; }
        .tab-btn {
            flex: 1; padding: 8px 0; border: none;
            background: #e0e0e0; cursor: pointer;
            font-size: 13px; transition: all 0.2s;
        }
        .tab-btn:first-child { border-radius: 8px 0 0 8px; }
        .tab-btn:last-child { border-radius: 0 8px 8px 0; }
        .tab-btn:not(:first-child):not(:last-child) { border-radius: 0; }
        .tab-btn.active { background: #7c4dff; color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .status {
            font-size: 12px; padding: 4px 8px;
            border-radius: 4px; margin-top: 8px; display: none;
        }
        .status.success { display: block; background: #e8f5e9; color: #2e7d32; }
        .status.error { display: block; background: #ffebee; color: #c62828; }
        .status.info { display: block; background: #e3f2fd; color: #1565c0; }
        .path-ok { color: #2e7d32; font-size: 12px; }
        .path-err { color: #c62828; font-size: 12px; }
        .param-row {
            display: flex; align-items: center; gap: 8px;
            padding: 4px 0; font-size: 12px;
        }
        .param-label { width: 100px; color: #555; }
        .param-value { flex: 1; color: #333; font-family: monospace; }
        .param-unmapped { color: #c62828; }
        .slider-row { display: flex; align-items: center; gap: 8px; margin: 8px 0; }
        .slider-row input[type="range"] { flex: 1; }
        .slider-val { width: 40px; text-align: center; font-size: 12px; }
        .expr-item {
            display: flex; align-items: center; gap: 8px;
            padding: 6px 0; border-bottom: 1px solid #f0f0f0;
            font-size: 12px;
        }
        .expr-item:last-child { border-bottom: none; }
        .expr-name { width: 80px; font-weight: 500; }
        .expr-dur { width: 60px; }
        .icon-preview { width: 32px; height: 32px; object-fit: contain; border-radius: 4px; }
        .model-info { font-size: 12px; color: #888; margin: 4px 0; }
        .image-item {
            display: flex; align-items: center; gap: 8px;
            padding: 8px 0; border-bottom: 1px solid #f0f0f0;
            font-size: 12px; flex-wrap: wrap;
        }
        .image-item:last-child { border-bottom: none; }
        .image-thumb {
            width: 50px; height: 50px;
            object-fit: cover; border-radius: 4px;
            flex-shrink: 0;
        }
        .image-item .cats { display: flex; gap: 8px; align-items: center; }
        .image-item .emotion-name {
            width: 70px; padding: 2px 4px; font-size: 12px;
            border: 1px solid #ddd; border-radius: 4px;
        }
        .lang-switcher {
            display: flex; align-items: center; gap: 8px;
            margin-bottom: 12px; font-size: 13px;
        }
        .lang-switcher select {
            width: auto; margin-bottom: 0; padding: 4px 8px;
        }
    </style>
</head>
<body>
    <div class="lang-switcher">
        <label data-i18n="lang.label">Language</label>
        <select id="lang-select">
            <option value="en">English</option>
            <option value="zh">中文</option>
            <option value="ja">日本語</option>
        </select>
    </div>

    <h1>Desktop Pet</h1>

    <div class="tabs">
        <button class="tab-btn active" data-tab="settings" data-i18n="tab.settings">Settings</button>
        <button class="tab-btn" data-tab="model" data-i18n="tab.model">Model</button>
        <button class="tab-btn" data-tab="emotion" data-i18n="tab.emotion">Emotion</button>
        <button class="tab-btn" data-tab="tts" data-i18n="tab.tts">TTS</button>
        <button class="tab-btn" data-tab="prompt" data-i18n="tab.prompt">Prompt</button>
    </div>

    <!-- Settings Tab -->
    <div id="tab-settings" class="tab-content active">
    <div class="card">
        <h2 data-i18n="api.title">API Configuration</h2>
        <p style="font-size:12px;color:#888;margin-bottom:8px;" data-i18n="api.hint">Tip: Register at openrouter.ai and go to openrouter.ai/keys to create an API Key. Supports many models including Grok, Gemini, etc.</p>
        <label data-i18n="api.baseUrl">API Base URL</label>
        <input type="text" id="api-url" placeholder="https://openrouter.ai/api/v1">
        <label data-i18n="api.key">API Key</label>
        <input type="password" id="api-key" placeholder="sk-...">
        <label data-i18n="api.model">Model Name</label>
        <input type="text" id="model-name" placeholder="x-ai/grok-4.1-fast">
        <div class="btn-row">
            <button class="btn btn-primary" id="btn-save-api" data-i18n="btn.save">Save</button>
            <button class="btn btn-secondary" id="btn-test-api" data-i18n="btn.test">Test</button>
        </div>
        <div class="status" id="api-status"></div>
    </div>
    <div class="card">
        <h2 data-i18n="tl.title">Translation API (for TTS)</h2>
        <p style="font-size:12px;color:#888;margin-bottom:8px;" data-i18n="tl.hint">Leave empty to reuse main API settings</p>
        <label>API Base URL</label>
        <input type="text" id="tl-api-url" data-i18n-ph="tl.placeholder">
        <label>API Key</label>
        <input type="password" id="tl-api-key" data-i18n-ph="tl.placeholder">
        <label>Model Name</label>
        <input type="text" id="tl-model-name" data-i18n-ph="tl.placeholder">
        <button class="btn btn-primary" id="btn-save-tl" data-i18n="btn.save">Save</button>
        <div class="status" id="tl-status"></div>
    </div>
    <div class="card">
        <h2 data-i18n="detect.title">Detection Settings</h2>
        <label data-i18n="detect.interval">API send frequency (sec)</label>
        <input type="number" id="interval" value="30" min="10" max="300">
        <label data-i18n="detect.chatGap">Min chat gap (sec)</label>
        <input type="number" id="chat-gap" value="5" min="0" max="60">
        <button class="btn btn-primary" id="btn-save-interval" data-i18n="btn.save">Save</button>
    </div>
    <div class="card">
        <div class="btn-row">
            <button class="btn btn-primary" id="btn-start" style="flex:1" data-i18n="btn.start">Start Pet</button>
            <button class="btn btn-danger" id="btn-stop" style="flex:1" data-i18n="btn.stop">Stop Pet</button>
        </div>
    </div>
    <div class="card" style="text-align:center;font-size:12px;color:#888;padding:8px">
        <span data-i18n="footer.text">Open source & free. Get the latest version on</span> <a href="#" id="link-github" style="color:#58a6ff" data-i18n="footer.star">GitHub</a>
    </div>
    </div>

    <!-- Model Tab -->
    <div id="tab-model" class="tab-content">
    <div class="card">
        <h2 data-i18n="model.mode">Model Mode</h2>
        <select id="model-type">
            <option value="none" data-i18n="model.none">No Model (Guide)</option>
            <option value="live2d" data-i18n="model.live2d">Live2D</option>
            <option value="image" data-i18n="model.image">Image Folder</option>
        </select>
        <div class="status" id="model-status"></div>
    </div>
    <div class="card" id="card-live2d" style="display:none">
        <h2 data-i18n="model.l2d.title">Live2D Model</h2>
        <div class="btn-row">
            <button class="btn btn-primary" id="btn-import-l2d" data-i18n="model.l2d.select">Select Model Folder</button>
        </div>
        <div id="l2d-info" class="model-info"></div>
        <label style="display:inline-flex;align-items:center;gap:4px;margin-top:8px;">
            <input type="checkbox" id="copy-to-userdata" checked> <span data-i18n="model.l2d.copy">Copy to app data directory</span>
        </label>
        <div id="l2d-path-status"></div>
    </div>
    <div class="card" id="card-param-mapping" style="display:none">
        <h2 data-i18n="model.param.title">Parameter Mapping</h2>
        <div id="param-mapping-list"></div>
        <div class="btn-row">
            <button class="btn btn-secondary btn-sm" id="btn-apply-suggested" data-i18n="model.param.apply">Apply Suggested Mapping</button>
        </div>
    </div>
    <div class="card" id="card-canvas-y" style="display:none">
        <h2 data-i18n="model.canvas.title">Canvas Y Anchor</h2>
        <div class="slider-row">
            <input type="range" id="canvas-y-slider" min="0.3" max="0.9" step="0.01" value="0.60">
            <span class="slider-val" id="canvas-y-val">0.60</span>
        </div>
    </div>
    <div class="card" id="card-image" style="display:none">
        <h2 data-i18n="model.img.title">Image Folder</h2>
        <div class="btn-row">
            <button class="btn btn-primary" id="btn-select-image-folder" data-i18n="model.img.select">Select Image Folder</button>
        </div>
        <div id="folder-info" class="model-info"></div>
        <div id="image-list-container" style="display:none; margin-top:12px;">
            <div style="margin-bottom:8px;">
                <label data-i18n="model.img.crop">Crop Scale (1.0=original, higher crops more bottom)</label>
                <div class="slider-row">
                    <input type="range" id="image-crop-slider" min="0.8" max="2.0" step="0.05" value="1.0">
                    <span class="slider-val" id="image-crop-val">1.00</span>
                </div>
            </div>
            <div id="image-list" style="max-height:400px; overflow-y:auto;"></div>
        </div>
    </div>
    <div class="card">
        <h2 data-i18n="model.bubble.title">Bubble Frame</h2>
        <div class="btn-row">
            <button class="btn btn-secondary" id="btn-select-bubble" data-i18n="model.bubble.select">Select Bubble Image</button>
            <button class="btn btn-secondary" id="btn-clear-bubble" data-i18n="model.bubble.clear">Clear</button>
        </div>
        <div id="bubble-info" class="model-info"></div>
    </div>
    <div class="card">
        <h2 data-i18n="model.icon.title">App Icon</h2>
        <div style="display:flex;align-items:center;gap:8px;">
            <img id="icon-preview" class="icon-preview" src="" style="display:none">
            <button class="btn btn-secondary" id="btn-select-icon" data-i18n="model.icon.select">Select Icon</button>
        </div>
        <div id="icon-info" class="model-info"></div>
    </div>
    <div class="card">
        <div class="btn-row">
            <button class="btn btn-primary" id="btn-save-model" data-i18n="model.save">Save Model Settings</button>
            <button class="btn btn-danger" id="btn-clear-model" data-i18n="model.clear">Clear Model</button>
        </div>
    </div>
    </div>

    <!-- Emotion Tab -->
    <div id="tab-emotion" class="tab-content">
    <div class="card">
        <h2 data-i18n="emo.freq.title">Expression Frequency</h2>
        <label data-i18n="emo.freq.label">Expected frequency (sec, min 30)</label>
        <input type="number" id="emotion-frequency" value="60" min="30" max="600">
        <button class="btn btn-primary" id="btn-save-emotion-freq" data-i18n="btn.save">Save</button>
        <div style="margin-top:8px;">
            <label><input type="checkbox" id="allow-simultaneous"> <span data-i18n="emo.simultaneous">Allow simultaneous expression & motion</span></label>
        </div>
        <div class="status" id="emotion-status"></div>
    </div>
    <div class="card">
        <h2 data-i18n="emo.expr.title">Expression List</h2>
        <p class="model-info" id="expr-hint" data-i18n="emo.expr.hint">Expressions auto-load after model import.</p>
        <div id="expression-list"></div>
        <div class="btn-row">
            <button class="btn btn-secondary btn-sm" id="btn-add-expr" data-i18n="emo.expr.add">Add Expression</button>
        </div>
        <div class="status" id="expr-status"></div>
    </div>
    <div class="card">
        <h2 data-i18n="emo.motion.title">Motion List</h2>
        <p class="model-info" id="motion-hint" data-i18n="emo.motion.hint">Motions auto-load after model import.</p>
        <div id="motion-list"></div>
        <div class="btn-row">
            <button class="btn btn-secondary btn-sm" id="btn-add-motion" data-i18n="emo.motion.add">Add Motion</button>
        </div>
        <div class="status" id="motion-status"></div>
    </div>
    <div class="card">
        <label data-i18n="emo.defExprDur">Default expression duration (sec)</label>
        <input type="number" id="default-expr-duration" value="5" min="1" max="30" step="0.5">
        <label data-i18n="emo.defMotionDur">Default motion duration (sec)</label>
        <input type="number" id="default-motion-duration" value="3" min="1" max="30" step="0.5">
        <button class="btn btn-primary" id="btn-save-expressions" data-i18n="emo.save">Save Expression Settings</button>
        <div class="status" id="save-emotion-status"></div>
    </div>
    </div>

    <!-- TTS Tab -->
    <div id="tab-tts" class="tab-content">
    <div class="card">
        <h2 data-i18n="tts.title">VOICEVOX TTS</h2>
        <div class="status" id="tts-status"></div>
        <p class="model-info" id="tts-hint" data-i18n="tts.hint">Requires voicevox_core directory. Status auto-detected on startup.</p>
        <div style="display:flex; gap:8px; align-items:center; margin:8px 0;">
            <button class="btn btn-primary" id="btn-setup-voicevox" data-i18n="tts.setup">One-click Install VOICEVOX</button>
            <button class="btn btn-secondary" id="btn-restart-tts" style="display:none;" data-i18n="tts.restart">Restart TTS</button>
        </div>
        <div class="status" id="voicevox-setup-status"></div>
        <p class="model-info" data-i18n="tts.dlNote">Requires internet. Auto-downloads Core + ONNX Runtime + Dictionary + Default voice model (~120MB).</p>
        <div style="margin-top:8px;">
            <label><input type="checkbox" id="tts-gpu-mode"> <span data-i18n="tts.gpu">GPU Acceleration (DirectML)</span></label>
            <p class="model-info" data-i18n="tts.gpuNote">Requires downloading voicevox_onnxruntime-win-x64-dml-1.17.3. Restart TTS after saving.</p>
        </div>
    </div>
    <div class="card">
        <h2 data-i18n="tts.audioMode">Audio Mode</h2>
        <div style="display:flex;gap:16px;margin:8px 0;">
            <label><input type="radio" name="audio-mode" value="tts" checked> <span data-i18n="tts.mode.tts">TTS Voice Synthesis</span></label>
            <label><input type="radio" name="audio-mode" value="default-audio"> <span data-i18n="tts.mode.default">Default Audio</span></label>
            <label><input type="radio" name="audio-mode" value="silent"> <span data-i18n="tts.mode.silent">Silent</span></label>
        </div>
        <p class="model-info" id="audio-mode-hint" data-i18n="tts.modeHint">Auto fallback: TTS → Default Audio → Silent when unavailable.</p>
    </div>
    <div class="card">
        <label data-i18n="tts.speaker">Speaker</label>
        <select id="tts-speaker"></select>
        <label data-i18n="tts.style">Style</label>
        <select id="tts-style-id"></select>
        <label data-i18n="tts.speed">Speed</label>
        <input type="range" id="tts-speed" min="0.5" max="2.0" step="0.1" value="1.0">
        <span id="tts-speed-val">1.0</span>
        <label data-i18n="tts.pitch">Pitch</label>
        <input type="range" id="tts-pitch" min="-0.15" max="0.15" step="0.01" value="0.0">
        <span id="tts-pitch-val">0.0</span>
        <label data-i18n="tts.volume">Volume</label>
        <input type="range" id="tts-volume" min="0.0" max="2.0" step="0.1" value="1.0">
        <span id="tts-volume-val">1.0</span>
        <button class="btn btn-primary" id="btn-save-tts" data-i18n="tts.save">Save TTS Settings</button>
        <div class="status" id="tts-save-status"></div>
    </div>
    <div class="card">
        <h2 data-i18n="tts.test.title">Test</h2>
        <input type="text" id="tts-test-text" data-i18n-ph="tts.test.placeholder" value="">
        <button class="btn btn-secondary" id="btn-test-tts" data-i18n="tts.test.btn">Test Voice</button>
        <div class="status" id="tts-test-status"></div>
    </div>
    <div class="card">
        <h2 data-i18n="tts.defAudio.title">Default Audio</h2>
        <p class="model-info" data-i18n="tts.defAudio.desc">Pre-generated filler phrases played when TTS is unavailable. Synthesized with current speaker/style.</p>
        <label data-i18n="tts.defAudio.label">Phrase list (one per line)</label>
        <textarea id="default-audio-phrases" rows="4" style="width:100%;font-size:12px;resize:vertical;">えっと
うーん
へぇ
ふーん
あっ</textarea>
        <button class="btn btn-secondary" id="btn-generate-default-audio" data-i18n="tts.defAudio.gen">Generate Default Audio</button>
        <div class="status" id="default-audio-status"></div>
    </div>
    <div class="card">
        <h2 data-i18n="tts.vvm.title">Voice Model (VVM)</h2>
        <p class="model-info" data-i18n="tts.vvm.hint">Check VVM files to load. Restart required after saving.</p>
        <div id="vvm-checkboxes" style="max-height:200px;overflow-y:auto;margin:8px 0;"></div>
        <button class="btn btn-primary" id="btn-save-vvm" data-i18n="tts.vvm.save">Save VVM Config (restart required)</button>
        <div class="status" id="vvm-save-status"></div>
    </div>
    </div>

    <!-- Prompt Tab -->
    <div id="tab-prompt" class="tab-content">
    <div class="card">
        <h2 data-i18n="prompt.card">Character Card</h2>
        <div style="display:flex; gap:8px; align-items:center; margin-bottom:4px;">
            <select id="character-select" style="flex:1;"></select>
        </div>
        <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
            <button class="btn btn-secondary" id="btn-new-character" title="New">+</button>
            <button class="btn btn-secondary" id="btn-import-character" title="Import">↓</button>
            <button class="btn btn-secondary" id="btn-rename-character" title="Rename">✎</button>
            <button class="btn btn-secondary" id="btn-delete-character" title="Delete">✕</button>
            <button class="btn btn-secondary" id="btn-reset-builtin" title="Reset Built-in Cards">⟲</button>
        </div>
        <div id="character-name-input-row" style="display:none; gap:8px; align-items:center;">
            <input type="text" id="character-name-input" data-i18n-ph="prompt.newName.ph" style="flex:1;">
            <button class="btn btn-primary" id="btn-confirm-name" data-i18n="prompt.confirm">OK</button>
            <button class="btn btn-secondary" id="btn-cancel-name" data-i18n="prompt.cancel">Cancel</button>
        </div>
    </div>
    <div class="card">
        <h2 data-i18n="prompt.name">Character Name</h2>
        <input type="text" id="prompt-name" data-i18n-ph="prompt.name.ph">
    </div>
    <div class="card">
        <h2 data-i18n="prompt.identity">Character Identity</h2>
        <label data-i18n="prompt.identity.desc">Character's relationship to user (e.g., sister, friend, assistant)</label>
        <input type="text" id="prompt-user-identity" placeholder="妹妹">
    </div>
    <div class="card">
        <h2 data-i18n="prompt.term">Address Term</h2>
        <label data-i18n="prompt.term.desc">How character addresses user (e.g., you, bro, master)</label>
        <input type="text" id="prompt-user-term" placeholder="你">
    </div>
    <div class="card">
        <h2 data-i18n="prompt.desc">Description</h2>
        <textarea id="prompt-desc" rows="4" data-i18n-ph="prompt.desc.ph"></textarea>
    </div>
    <div class="card">
        <h2 data-i18n="prompt.personality">Personality</h2>
        <textarea id="prompt-personality" rows="4" data-i18n-ph="prompt.personality.ph"></textarea>
    </div>
    <div class="card">
        <h2 data-i18n="prompt.scenario">Scenario</h2>
        <textarea id="prompt-scenario" rows="6" data-i18n-ph="prompt.scenario.ph"></textarea>
    </div>
    <div class="card">
        <h2 data-i18n="prompt.rules">Hard Rules</h2>
        <textarea id="prompt-rules" rows="4" data-i18n-ph="prompt.rules.ph"></textarea>
    </div>
    <div class="card">
        <h2 data-i18n="prompt.language">Response Language</h2>
        <input type="text" id="prompt-language" data-i18n-ph="prompt.language.ph">
    </div>
    <div class="card">
        <div class="btn-row">
            <button class="btn btn-primary" id="btn-save-prompt" data-i18n="prompt.save">Save</button>
        </div>
        <div class="status" id="prompt-status"></div>
    </div>
    </div>

    <script src="src/i18n/locales.js"></script>
    <script src="src/core/ai-chat.js"></script>
    <script src="src/core/prompt-builder.js"></script>
    <script src="src/core/emotion-system.js"></script>
    <script src="src/core/audio-state-machine.js"></script>
    <script src="src/core/message-session.js"></script>
    <script src="src/core/desktop-pet-system.js"></script>
    <script src="src/renderer/settings-ui.js"></script>
</body>
</html>
